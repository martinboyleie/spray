<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spray Tracker - Offline</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Spray Tracker">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            max-width: 800px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        
        .btn-location {
            min-height: 80px;
            font-size: 1.1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .btn-location:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-location.used::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 10px;
            color: #28a745;
            font-weight: bold;
        }
        
        .mouth-diagram {
            width: 300px;
            height: 200px;
            margin: 20px auto;
            position: relative;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 50px;
        }
        
        .location-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #007bff;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .location-marker.left-mouth { left: 20px; top: 50%; transform: translateY(-50%); }
        .location-marker.right-mouth { right: 20px; top: 50%; transform: translateY(-50%); }
        .location-marker.under-tongue { left: 50%; bottom: 20px; transform: translateX(-50%); }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
            color: #212529 !important;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .nav-pills .nav-link:hover {
            color: #0d6efd !important;
            text-shadow: 0 0 8px rgba(13, 110, 253, 0.3);
            transform: translateY(-1px);
        }
        
        .nav-pills .nav-link:focus {
            color: #0d6efd !important;
            outline: 2px solid rgba(13, 110, 253, 0.3);
            outline-offset: 2px;
        }
        
        .nav-pills .nav-link.active {
            color: #ffffff !important;
            background-color: #0d6efd !important;
        }
        
        .nav-pills .nav-link.active:hover {
            color: #ffffff !important;
            background-color: #0a58ca !important;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .toast-notification {
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .btn {
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .btn-location {
                min-height: 60px;
                font-size: 1rem;
            }
            
            .mouth-diagram {
                width: 250px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Navigation -->
        <nav class="mb-4">
            <ul class="nav nav-pills justify-content-center">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-page="dashboard">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="history">
                        <i class="fas fa-history me-2"></i>History
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="schedule">
                        <i class="fas fa-clock me-2"></i>Schedule
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page active">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card text-center">
                        <div class="card-body">
                            <h1 class="card-title text-primary mb-0">
                                <i class="fas fa-spray-can me-2"></i>Spray Tracker
                            </h1>
                            <p class="text-muted">Track your medicinal spray locations</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Status -->
            <div id="schedule-status" class="mb-4"></div>

            <!-- Next Location -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-bullseye me-2 text-primary"></i>Next Location
                            </h5>
                            <h3 class="text-primary mb-0">
                                <span id="next-location-name">Left of Mouth</span>
                                <small class="text-muted">(Location #<span id="next-location-id">1</span>)</small>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mouth Diagram -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-map-marker-alt me-2"></i>Spray Locations
                            </h5>
                            <div class="mouth-diagram mx-auto">
                                <div class="location-marker left-mouth" title="Left of Mouth"></div>
                                <div class="location-marker right-mouth" title="Right of Mouth"></div>
                                <div class="location-marker under-tongue" title="Under the Tongue"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Buttons -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <button id="spray-btn-1" class="btn btn-primary btn-location w-100">
                        <i class="fas fa-arrow-left me-2"></i>
                        <div>Left of Mouth</div>
                        <small class="d-block">Press 1</small>
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button id="spray-btn-2" class="btn btn-outline-secondary btn-location w-100">
                        <i class="fas fa-arrow-right me-2"></i>
                        <div>Right of Mouth</div>
                        <small class="d-block">Press 2</small>
                    </button>
                </div>
                <div class="col-md-4 mb-3">
                    <button id="spray-btn-3" class="btn btn-outline-secondary btn-location w-100">
                        <i class="fas fa-arrow-down me-2"></i>
                        <div>Under the Tongue</div>
                        <small class="d-block">Press 3</small>
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                            <h5>Total Sprays</h5>
                            <h3 class="text-primary" id="total-sprays">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-sync-alt fa-2x text-success mb-2"></i>
                            <h5>Current Cycle</h5>
                            <h3 class="text-success" id="current-cycle">1</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x text-info mb-2"></i>
                            <h5>Locations Used</h5>
                            <h3 class="text-info" id="locations-used">0/3</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent History -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>Recent Sprays
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="recent-history">
                                <p class="text-muted">No recent sprays</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="row">
                <div class="col-12 text-center">
                    <button id="reset-cycle-btn" class="btn btn-warning me-2">
                        <i class="fas fa-redo me-2"></i>Reset Cycle
                    </button>
                    <button onclick="sprayTracker.clearData()" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Clear All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div id="history-page" class="page">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-history me-2"></i>Spray History
                                <small class="text-muted">(Last 30 days)</small>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h5>Total Sprays</h5>
                                        <h3 class="text-primary" id="history-total">0</h3>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center">
                                        <h5>Today's Sprays</h5>
                                        <h3 class="text-success" id="history-today">0</h3>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Location</th>
                                            <th>Date & Time</th>
                                            <th>Cycle</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-list">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No history available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Page -->
        <div id="schedule-page" class="page">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-clock me-2"></i>Schedule Configuration
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="schedule-form">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="schedule-enabled" name="enabled">
                                            <label class="form-check-label" for="schedule-enabled">
                                                <strong>Enable Schedule</strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="schedule-start" class="form-label">Start Time</label>
                                        <input type="time" class="form-control" id="schedule-start" name="start_time" value="07:00">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="schedule-end" class="form-label">End Time</label>
                                        <input type="time" class="form-control" id="schedule-end" name="end_time" value="23:59">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="schedule-hours" class="form-label">Interval Hours</label>
                                        <input type="number" class="form-control" id="schedule-hours" name="interval_hours" min="0" max="23" value="4">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="schedule-minutes" class="form-label">Interval Minutes</label>
                                        <input type="number" class="form-control" id="schedule-minutes" name="interval_minutes" min="0" max="59" value="0">
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save Schedule
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Offline Spray Tracker - Complete Client-Side Application
        class SprayTracker {
            constructor() {
                this.storageKey = 'sprayTrackerData';
                this.data = this.loadData();
                this.lastAlertTime = null;
                this.alertCheckInterval = null;
                this.hasShownNotificationPermission = false;
                this.init();
            }

            // Default data structure
            getDefaultData() {
                return {
                    locations: {
                        '1': { name: "Left of Mouth", position: "left-mouth", used: false, last_used: null },
                        '2': { name: "Right of Mouth", position: "right-mouth", used: false, last_used: null },
                        '3': { name: "Under the Tongue", position: "under-tongue", used: false, last_used: null }
                    },
                    history: [],
                    total_sprays: 0,
                    current_cycle: 1,
                    schedule: {
                        enabled: false,
                        start_time: "07:00",
                        end_time: "23:59",
                        interval_hours: 4,
                        interval_minutes: 0
                    }
                };
            }

            // Load data from localStorage
            loadData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const data = JSON.parse(stored);
                        const defaultData = this.getDefaultData();
                        return { ...defaultData, ...data };
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                }
                return this.getDefaultData();
            }

            // Save data to localStorage
            saveData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            }

            // Initialize the application
            init() {
                this.renderDashboard();
                this.setupEventListeners();
                this.startAutoRefresh();
                this.initializeScheduleAlerts();
            }

            // Get next location to spray
            getNextLocation() {
                const locations = this.data.locations;
                const unused = Object.keys(locations).filter(id => !locations[id].used);
                
                if (unused.length > 0) {
                    return unused.sort((a, b) => parseInt(a) - parseInt(b))[0];
                } else {
                    // Reset cycle
                    Object.values(locations).forEach(loc => loc.used = false);
                    this.data.current_cycle++;
                    this.saveData();
                    return '1';
                }
            }

            // Record a spray
            recordSpray(locationId) {
                const location = this.data.locations[locationId];
                if (!location) return;

                // Update location
                location.used = true;
                location.last_used = new Date().toISOString();

                // Add to history
                const historyEntry = {
                    location_id: locationId,
                    location_name: location.name,
                    timestamp: new Date().toISOString(),
                    cycle: this.data.current_cycle
                };
                this.data.history.push(historyEntry);
                this.data.total_sprays++;

                this.saveData();
                this.renderDashboard();
                this.showToast(`Spray recorded at ${location.name}`);
            }

            // Calculate schedule times
            calculateScheduleTimes(schedule) {
                if (!schedule.enabled) return [];

                const times = [];
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                const [startHour, startMin] = schedule.start_time.split(':').map(Number);
                const [endHour, endMin] = schedule.end_time.split(':').map(Number);
                
                let current = new Date(today);
                current.setHours(startHour, startMin, 0, 0);
                
                const end = new Date(today);
                end.setHours(endHour, endMin, 0, 0);
                if (end < current) end.setDate(end.getDate() + 1);
                
                const intervalMs = (schedule.interval_hours * 60 + schedule.interval_minutes) * 60 * 1000;
                
                while (current <= end) {
                    times.push(new Date(current));
                    current = new Date(current.getTime() + intervalMs);
                }
                
                return times;
            }

            // Get schedule status
            getScheduleStatus() {
                const schedule = this.data.schedule;
                if (!schedule.enabled) {
                    return { enabled: false, next_spray_time: null, is_overdue: false };
                }

                const scheduledTimes = this.calculateScheduleTimes(schedule);
                const now = new Date();
                const today = now.toDateString();
                
                // Get today's sprays
                const todayHistory = this.data.history.filter(entry => {
                    return new Date(entry.timestamp).toDateString() === today;
                }).map(entry => new Date(entry.timestamp));

                // Find completed times (within 30 minutes)
                const completedTimes = scheduledTimes.filter(scheduledTime => {
                    return todayHistory.some(sprayTime => {
                        const diffMinutes = Math.abs(sprayTime - scheduledTime) / (1000 * 60);
                        return diffMinutes <= 30;
                    });
                });

                // Find next spray time
                let nextSprayTime = null;
                let isOverdue = false;

                // First look for future times
                for (const scheduledTime of scheduledTimes) {
                    if (scheduledTime > now && !completedTimes.includes(scheduledTime)) {
                        nextSprayTime = scheduledTime;
                        break;
                    }
                }

                // If no future times, look for overdue
                if (!nextSprayTime) {
                    for (const scheduledTime of scheduledTimes) {
                        if (scheduledTime <= now && !completedTimes.includes(scheduledTime)) {
                            nextSprayTime = scheduledTime;
                            isOverdue = true;
                            break;
                        }
                    }
                }

                return {
                    enabled: true,
                    next_spray_time: nextSprayTime,
                    is_overdue: isOverdue,
                    scheduled_times: scheduledTimes,
                    completed_times: completedTimes
                };
            }

            // Format datetime
            formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            // Render dashboard
            renderDashboard() {
                const nextLocationId = this.getNextLocation();
                const nextLocation = this.data.locations[nextLocationId];
                const scheduleStatus = this.getScheduleStatus();
                
                // Update next location
                document.getElementById('next-location-name').textContent = nextLocation.name;
                document.getElementById('next-location-id').textContent = nextLocationId;
                
                // Update statistics
                document.getElementById('total-sprays').textContent = this.data.total_sprays;
                document.getElementById('current-cycle').textContent = this.data.current_cycle;
                
                const usedCount = Object.values(this.data.locations).filter(loc => loc.used).length;
                document.getElementById('locations-used').textContent = `${usedCount}/3`;
                
                // Update schedule status
                this.updateScheduleStatus(scheduleStatus);
                
                // Update location buttons
                this.updateLocationButtons(nextLocationId);
                
                // Update recent history
                this.updateRecentHistory();
            }

            // Update schedule status display
            updateScheduleStatus(status) {
                const statusElement = document.getElementById('schedule-status');
                if (!statusElement) return;

                if (!status.enabled) {
                    statusElement.innerHTML = '<div class="alert alert-info">Schedule is disabled</div>';
                    return;
                }

                if (!status.next_spray_time) {
                    statusElement.innerHTML = '<div class="alert alert-success">All scheduled sprays completed for today!</div>';
                    return;
                }

                const timeStr = status.next_spray_time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                if (status.is_overdue) {
                    const overdueMins = Math.floor((new Date() - status.next_spray_time) / (1000 * 60));
                    statusElement.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Overdue!</strong> Scheduled spray was at ${timeStr} (${overdueMins} minutes ago)
                        </div>
                    `;
                } else {
                    const untilMins = Math.floor((status.next_spray_time - new Date()) / (1000 * 60));
                    statusElement.innerHTML = `
                        <div class="alert alert-info">
                            Next scheduled spray: ${timeStr} (in ${untilMins} minutes)
                        </div>
                    `;
                }
            }

            // Update location buttons
            updateLocationButtons(nextLocationId) {
                Object.keys(this.data.locations).forEach(id => {
                    const button = document.getElementById(`spray-btn-${id}`);
                    if (button) {
                        const location = this.data.locations[id];
                        const isNext = id === nextLocationId;
                        
                        button.className = `btn btn-location w-100 ${isNext ? 'btn-primary' : 'btn-outline-secondary'}`;
                        if (location.used) {
                            button.classList.add('used');
                        }
                    }
                });
            }

            // Update recent history
            updateRecentHistory() {
                const historyElement = document.getElementById('recent-history');
                if (!historyElement) return;

                const recentHistory = this.data.history.slice(-5).reverse();
                
                if (recentHistory.length === 0) {
                    historyElement.innerHTML = '<p class="text-muted">No recent sprays</p>';
                    return;
                }

                historyElement.innerHTML = recentHistory.map(entry => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${entry.location_name}</span>
                        <small class="text-muted">${this.formatDateTime(entry.timestamp)}</small>
                    </div>
                `).join('');
            }

            // Setup event listeners
            setupEventListeners() {
                // Location buttons
                Object.keys(this.data.locations).forEach(id => {
                    const button = document.getElementById(`spray-btn-${id}`);
                    if (button) {
                        button.addEventListener('click', () => this.recordSpray(id));
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key >= '1' && e.key <= '3') {
                        const target = e.target;
                        // Don't trigger if user is typing in an input field
                        if (target.tagName.toLowerCase() === 'input' || 
                            target.tagName.toLowerCase() === 'textarea' ||
                            target.tagName.toLowerCase() === 'select' ||
                            target.contentEditable === 'true') {
                            return;
                        }
                        
                        e.preventDefault();
                        this.recordSpray(e.key);
                    }
                });

                // Reset cycle button
                const resetBtn = document.getElementById('reset-cycle-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => this.resetCycle());
                }

                // Schedule form
                const scheduleForm = document.getElementById('schedule-form');
                if (scheduleForm) {
                    scheduleForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.updateSchedule();
                    });
                }

                // Navigation
                document.querySelectorAll('[data-page]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showPage(link.dataset.page);
                    });
                });
            }

            // Reset cycle
            resetCycle() {
                Object.values(this.data.locations).forEach(loc => loc.used = false);
                this.data.current_cycle++;
                this.saveData();
                this.renderDashboard();
                this.showToast('Cycle reset!');
            }

            // Update schedule
            updateSchedule() {
                const form = document.getElementById('schedule-form');
                const formData = new FormData(form);
                
                this.data.schedule = {
                    enabled: formData.get('enabled') === 'on',
                    start_time: formData.get('start_time'),
                    end_time: formData.get('end_time'),
                    interval_hours: parseInt(formData.get('interval_hours')),
                    interval_minutes: parseInt(formData.get('interval_minutes'))
                };
                
                this.saveData();
                this.renderDashboard();
                this.showToast('Schedule updated!');
            }

            // Show page
            showPage(pageName) {
                // Update navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
                
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                // Show selected page
                const page = document.getElementById(`${pageName}-page`);
                if (page) {
                    page.classList.add('active');
                    
                    // Render page content
                    if (pageName === 'history') {
                        this.renderHistoryPage();
                    } else if (pageName === 'schedule') {
                        this.renderSchedulePage();
                    }
                }
            }

            // Render history page
            renderHistoryPage() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const recentHistory = this.data.history.filter(entry => {
                    return new Date(entry.timestamp) >= thirtyDaysAgo;
                });
                
                const today = new Date().toDateString();
                const todayCount = recentHistory.filter(entry => {
                    return new Date(entry.timestamp).toDateString() === today;
                }).length;
                
                // Update stats
                document.getElementById('history-total').textContent = recentHistory.length;
                document.getElementById('history-today').textContent = todayCount;
                
                // Update history list
                const historyList = document.getElementById('history-list');
                if (historyList) {
                    if (recentHistory.length === 0) {
                        historyList.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No history in the last 30 days</td></tr>';
                    } else {
                        historyList.innerHTML = recentHistory.reverse().map((entry, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${entry.location_name}</td>
                                <td>${this.formatDateTime(entry.timestamp)}</td>
                                <td>Cycle ${entry.cycle}</td>
                            </tr>
                        `).join('');
                    }
                }
            }

            // Render schedule page
            renderSchedulePage() {
                const schedule = this.data.schedule;
                
                // Populate form
                document.getElementById('schedule-enabled').checked = schedule.enabled;
                document.getElementById('schedule-start').value = schedule.start_time;
                document.getElementById('schedule-end').value = schedule.end_time;
                document.getElementById('schedule-hours').value = schedule.interval_hours;
                document.getElementById('schedule-minutes').value = schedule.interval_minutes;
            }

            // Show toast notification
            showToast(message) {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #28a745;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 5px;
                    z-index: 9999;
                    font-weight: bold;
                `;
                
                document.body.appendChild(toast);
                
                // Remove after 2 seconds
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 2000);
            }

            // Auto refresh
            startAutoRefresh() {
                setInterval(() => {
                    this.renderDashboard();
                }, 30000); // Refresh every 30 seconds
            }

            // Clear all data
            clearData() {
                if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    localStorage.removeItem(this.storageKey);
                    this.data = this.getDefaultData();
                    this.renderDashboard();
                    this.showToast('All data cleared!');
                }
            }

            // Initialize schedule alerts
            initializeScheduleAlerts() {
                // Request notification permission
                this.requestNotificationPermission();
                
                // Start checking for schedule alerts every minute
                this.alertCheckInterval = setInterval(() => this.checkScheduleAlerts(), 60000);
                
                // Check immediately after 2 seconds
                setTimeout(() => this.checkScheduleAlerts(), 2000);
            }

            // Request notification permission
            async requestNotificationPermission() {
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications');
                    return;
                }
                
                if (Notification.permission === 'default' && !this.hasShownNotificationPermission) {
                    this.hasShownNotificationPermission = true;
                    try {
                        const permission = await Notification.requestPermission();
                        console.log('Notification permission:', permission);
                    } catch (error) {
                        console.log('Error requesting notification permission:', error);
                    }
                }
            }

            // Check for schedule alerts
            checkScheduleAlerts() {
                const scheduleStatus = this.getScheduleStatus();
                
                if (scheduleStatus.enabled && scheduleStatus.next_spray_time) {
                    const nextSprayTime = new Date(scheduleStatus.next_spray_time);
                    const now = new Date();
                    
                    // Check if it's time for an alert (within 5 minutes or overdue)
                    const minutesUntilSpray = (nextSprayTime - now) / (1000 * 60);
                    const shouldAlert = scheduleStatus.is_overdue || (minutesUntilSpray <= 5 && minutesUntilSpray >= 0);
                    
                    if (shouldAlert) {
                        const alertKey = nextSprayTime.toISOString();
                        
                        // Only show alert once per scheduled time
                        if (this.lastAlertTime !== alertKey) {
                            this.lastAlertTime = alertKey;
                            this.showScheduleAlert(scheduleStatus);
                        }
                    }
                }
            }

            // Show schedule alert
            showScheduleAlert(scheduleStatus) {
                const nextSprayTime = new Date(scheduleStatus.next_spray_time);
                const timeString = nextSprayTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let title, message;
                
                if (scheduleStatus.is_overdue) {
                    title = '⏰ Spray Overdue!';
                    message = `Your scheduled spray at ${timeString} is overdue. Time to take your medication!`;
                } else {
                    title = '🔔 Spray Reminder';
                    message = `Time for your scheduled spray at ${timeString}!`;
                }
                
                // Try to show browser notification first
                if (this.showBrowserNotification(title, message)) {
                    console.log('Browser notification shown');
                } else {
                    // Fallback to visual alert
                    this.showVisualAlert(title, message);
                }
                
                // Also show toast notification
                this.showToast(message);
                
                // Play notification sound if available
                this.playNotificationSound();
            }

            // Show browser notification
            showBrowserNotification(title, message) {
                if (!('Notification' in window) || Notification.permission !== 'granted') {
                    return false;
                }
                
                try {
                    const notification = new Notification(title, {
                        body: message,
                        requireInteraction: true,
                        tag: 'spray-reminder'
                    });
                    
                    // Auto-close after 10 seconds
                    setTimeout(() => notification.close(), 10000);
                    
                    // Handle click
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    return true;
                } catch (error) {
                    console.error('Error showing browser notification:', error);
                    return false;
                }
            }

            // Show visual alert
            showVisualAlert(title, message) {
                // Remove any existing alert
                const existingAlert = document.querySelector('.schedule-alert-overlay');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // Create alert overlay
                const alertOverlay = document.createElement('div');
                alertOverlay.className = 'schedule-alert-overlay';
                alertOverlay.innerHTML = `
                    <div class="schedule-alert-modal">
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <h5 class="alert-heading">${title}</h5>
                            <p class="mb-3">${message}</p>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary btn-sm" onclick="window.sprayTracker.dismissScheduleAlert()">
                                    <i class="fas fa-check me-1"></i>Got it!
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.sprayTracker.snoozeScheduleAlert()">
                                    <i class="fas fa-clock me-1"></i>Snooze 5min
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add styles if not already present
                if (!document.querySelector('#schedule-alert-styles')) {
                    const style = document.createElement('style');
                    style.id = 'schedule-alert-styles';
                    style.textContent = `
                        .schedule-alert-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.5);
                            z-index: 9999;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            animation: fadeIn 0.3s ease-in;
                        }
                        
                        .schedule-alert-modal {
                            max-width: 400px;
                            margin: 20px;
                            animation: slideIn 0.3s ease-out;
                        }
                        
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        
                        @keyframes slideIn {
                            from { transform: translateY(-50px); opacity: 0; }
                            to { transform: translateY(0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(alertOverlay);
                
                // Auto-dismiss after 30 seconds
                setTimeout(() => {
                    if (document.body.contains(alertOverlay)) {
                        this.dismissScheduleAlert();
                    }
                }, 30000);
            }

            // Dismiss schedule alert
            dismissScheduleAlert() {
                const overlay = document.querySelector('.schedule-alert-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }

            // Snooze schedule alert
            snoozeScheduleAlert() {
                this.dismissScheduleAlert();
                // Reset last alert time to allow re-alerting in 5 minutes
                setTimeout(() => {
                    this.lastAlertTime = null;
                }, 5 * 60 * 1000);
            }

            // Play notification sound
            playNotificationSound() {
                try {
                    // Create a simple beep sound using Web Audio API
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (error) {
                    console.log('Could not play notification sound:', error);
                }
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.sprayTracker = new SprayTracker();
        });
    </script>
</body>
</html> 